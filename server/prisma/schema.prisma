generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  PROFESSOR
  HOD
}

enum VerificationType {
  REGISTRATION
  PROFILE_UPDATE
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EnrollmentStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

model User {
  id                 String             @id @default(cuid())
  name               String
  email              String             @unique
  password           String
  role               Role               @default(STUDENT)
  profilePic         String?
  verificationStatus VerificationStatus @default(PENDING)
  refreshToken       String?
  notificationToken  String?

  studentProfile   Student?
  professorProfile Professor?
  hodProfile       Hod?

  createdRequests  VerificationRequest[] @relation("UserRequests")
  approvedRequests VerificationRequest[] @relation("UserApprovals")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserRequests", fields: [userId], references: [id])

  approvedById String?
  approvedBy   User?   @relation("UserApprovals", fields: [approvedById], references: [id])

  type        VerificationType
  status      VerificationStatus @default(PENDING)
  reason      String?
  updatedData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Department {
  id   String @id @default(cuid())
  name String @unique
  hod  Hod?

  semesters  Semester[]
  divisions  Division[]
  professors Professor[]
  students   Student[]
  subjects   Subject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Hod {
  id           String     @id @default(cuid())
  userId       String     @unique
  user         User       @relation(fields: [userId], references: [id])
  departmentId String     @unique
  department   Department @relation(fields: [departmentId], references: [id])
}

model Semester {
  id           String     @id @default(cuid())
  number       Int
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  divisions Division[]
  subjects  Subject[]
  students  Student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Division {
  id   String @id @default(cuid())
  name String

  semesterId   String
  semester     Semester   @relation(fields: [semesterId], references: [id])
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  students     Student[]
  subjectLinks DivisionSubjectAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, semesterId, departmentId])
}

model Subject {
  id          String  @id @default(cuid())
  name        String
  code        String
  description String?

  semesterId   String
  semester     Semester   @relation(fields: [semesterId], references: [id])
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  divisionLinks DivisionSubjectAssignment[]
  studentLinks  StudentSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, semesterId, departmentId])
}

model Professor {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  teacherId    String      @unique
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  teaches DivisionSubjectAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  enrollmentNo String   @unique
  savedNotes   String[] @default([])

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  semesterId String?
  semester   Semester? @relation(fields: [semesterId], references: [id])

  divisionId String?
  division   Division? @relation(fields: [divisionId], references: [id])

  enrollments StudentSubject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DivisionSubjectAssignment {
  id          String  @id @default(cuid())
  divisionId  String
  subjectId   String
  professorId String?

  division  Division   @relation(fields: [divisionId], references: [id])
  subject   Subject    @relation(fields: [subjectId], references: [id])
  professor Professor? @relation(fields: [professorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([divisionId, subjectId])
  @@index([professorId])
}

model StudentSubject {
  id         String           @id @default(cuid())
  studentId  String
  subjectId  String
  student    Student          @relation(fields: [studentId], references: [id])
  subject    Subject          @relation(fields: [subjectId], references: [id])
  status     EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime         @default(now())

  @@unique([studentId, subjectId])
  @@index([subjectId])
}
